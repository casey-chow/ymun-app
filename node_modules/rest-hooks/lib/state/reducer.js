import _defineProperty from "@babel/runtime/helpers/esm/defineProperty";
import _objectSpread from "@babel/runtime/helpers/esm/objectSpread2";
import { normalize } from "../resource";
import mergeDeepCopy from './merge/mergeDeepCopy';
import applyUpdatersToResults from './applyUpdatersToResults';
export var initialState = {
  entities: {},
  results: {},
  meta: {}
};
export default function reducer(state, action) {
  if (!state) state = initialState;

  switch (action.type) {
    case 'rest-hooks/receive':
      {
        if (action.error) {
          return _objectSpread({}, state, {
            meta: _objectSpread({}, state.meta, _defineProperty({}, action.meta.url, {
              date: action.meta.date,
              error: action.payload,
              expiresAt: action.meta.expiresAt
            }))
          });
        }

        var _normalize = normalize(action.payload, action.meta.schema),
            result = _normalize.result,
            entities = _normalize.entities;

        var results = _objectSpread({}, state.results, _defineProperty({}, action.meta.url, result));

        results = applyUpdatersToResults(results, result, action.meta.updaters);
        return {
          entities: mergeDeepCopy(state.entities, entities),
          results: results,
          meta: _objectSpread({}, state.meta, _defineProperty({}, action.meta.url, {
            date: action.meta.date,
            expiresAt: action.meta.expiresAt
          }))
        };
      }

    case 'rest-hooks/rpc':
      {
        if (action.error) return state;

        var _normalize2 = normalize(action.payload, action.meta.schema),
            _entities = _normalize2.entities,
            _result = _normalize2.result;

        var _results = applyUpdatersToResults(state.results, _result, action.meta.updaters);

        return _objectSpread({}, state, {
          entities: mergeDeepCopy(state.entities, _entities),
          results: _results
        });
      }

    case 'rest-hooks/purge':
      {
        if (action.error) return state;
        var key = action.meta.schema.key;
        var pk = action.meta.url;

        var _entities2 = purgeEntity(state.entities, key, pk);

        return _objectSpread({}, state, {
          entities: _entities2
        });
      }

    case 'rest-hooks/invalidate':
      return _objectSpread({}, state, {
        meta: _objectSpread({}, state.meta, _defineProperty({}, action.meta.url, _objectSpread({}, state.meta[action.meta.url], {
          expiresAt: 0
        })))
      });

    case 'rest-hooks/reset':
      return initialState;

    default:
      // If 'fetch' action reaches the reducer there are no middlewares installed to handle it
      if (process.env.NODE_ENV !== 'production' && action.type === 'rest-hooks/fetch') {
        console.warn('Reducer recieved fetch action - you are likely missing the NetworkManager middleware');
        console.warn('See https://resthooks.io/docs/guides/redux#indextsx for hooking up redux');
      } // A reducer must always return a valid state.
      // Alternatively you can throw an error if an invalid action is dispatched.


      return state;
  }
}

// equivalent to entities.deleteIn(key, pk)
function purgeEntity(entities, key, pk) {
  var copy = _objectSpread({}, entities);

  copy[key] = _objectSpread({}, copy[key]);
  delete copy[key][pk];
  return copy;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdGF0ZS9yZWR1Y2VyLnRzIl0sIm5hbWVzIjpbIm5vcm1hbGl6ZSIsIm1lcmdlRGVlcENvcHkiLCJhcHBseVVwZGF0ZXJzVG9SZXN1bHRzIiwiaW5pdGlhbFN0YXRlIiwiZW50aXRpZXMiLCJyZXN1bHRzIiwibWV0YSIsInJlZHVjZXIiLCJzdGF0ZSIsImFjdGlvbiIsInR5cGUiLCJlcnJvciIsInVybCIsImRhdGUiLCJwYXlsb2FkIiwiZXhwaXJlc0F0Iiwic2NoZW1hIiwicmVzdWx0IiwidXBkYXRlcnMiLCJrZXkiLCJwayIsInB1cmdlRW50aXR5IiwicHJvY2VzcyIsImVudiIsIk5PREVfRU5WIiwiY29uc29sZSIsIndhcm4iLCJjb3B5Il0sIm1hcHBpbmdzIjoiOztBQUFBLFNBQVNBLFNBQVQsUUFBMEIsYUFBMUI7QUFHQSxPQUFPQyxhQUFQLE1BQTBCLHVCQUExQjtBQUNBLE9BQU9DLHNCQUFQLE1BQW1DLDBCQUFuQztBQUVBLE9BQU8sSUFBTUMsWUFBNEIsR0FBRztBQUMxQ0MsRUFBQUEsUUFBUSxFQUFFLEVBRGdDO0FBRTFDQyxFQUFBQSxPQUFPLEVBQUUsRUFGaUM7QUFHMUNDLEVBQUFBLElBQUksRUFBRTtBQUhvQyxDQUFyQztBQU1QLGVBQWUsU0FBU0MsT0FBVCxDQUNiQyxLQURhLEVBRWJDLE1BRmEsRUFHRztBQUNoQixNQUFJLENBQUNELEtBQUwsRUFBWUEsS0FBSyxHQUFHTCxZQUFSOztBQUNaLFVBQVFNLE1BQU0sQ0FBQ0MsSUFBZjtBQUNFLFNBQUssb0JBQUw7QUFBMkI7QUFDekIsWUFBSUQsTUFBTSxDQUFDRSxLQUFYLEVBQWtCO0FBQ2hCLG1DQUNLSCxLQURMO0FBRUVGLFlBQUFBLElBQUksb0JBQ0NFLEtBQUssQ0FBQ0YsSUFEUCxzQkFFREcsTUFBTSxDQUFDSCxJQUFQLENBQVlNLEdBRlgsRUFFaUI7QUFDakJDLGNBQUFBLElBQUksRUFBRUosTUFBTSxDQUFDSCxJQUFQLENBQVlPLElBREQ7QUFFakJGLGNBQUFB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S0FBZ0Isa0JBRmxCLEVBR0U7QUFDQWUsUUFBQUEsT0FBTyxDQUFDQyxJQUFSLENBQ0Usc0ZBREY7QUFHQUQsUUFBQUEsT0FBTyxDQUFDQyxJQUFSLENBQ0UsMEVBREY7QUFHRCxPQVpILENBYUU7QUFDQTs7O0FBQ0EsYUFBT2xCLEtBQVA7QUE1Rko7QUE4RkQ7O0FBSUQ7QUFDQSxTQUFTYSxXQUFULENBQ0VqQixRQURGLEVBRUVlLEdBRkYsRUFHRUMsRUFIRixFQUlFO0FBQ0EsTUFBTU8sSUFBK0IscUJBQVF2QixRQUFSLENBQXJDOztBQUNBdUIsRUFBQUEsSUFBSSxDQUFDUixHQUFELENBQUoscUJBQWlCUSxJQUFJLENBQUNSLEdBQUQsQ0FBckI7QUFDQSxTQUFPUSxJQUFJLENBQUNSLEdBQUQsQ0FBSixDQUFVQyxFQUFWLENBQVA7QUFDQSxTQUFPTyxJQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBub3JtYWxpemUgfSBmcm9tICd+L3Jlc291cmNlJztcbmltcG9ydCB7IEFjdGlvblR5cGVzLCBTdGF0ZSB9IGZyb20gJ34vdHlwZXMnO1xuXG5pbXBvcnQgbWVyZ2VEZWVwQ29weSBmcm9tICcuL21lcmdlL21lcmdlRGVlcENvcHknO1xuaW1wb3J0IGFwcGx5VXBkYXRlcnNUb1Jlc3VsdHMgZnJvbSAnLi9hcHBseVVwZGF0ZXJzVG9SZXN1bHRzJztcblxuZXhwb3J0IGNvbnN0IGluaXRpYWxTdGF0ZTogU3RhdGU8dW5rbm93bj4gPSB7XG4gIGVudGl0aWVzOiB7fSxcbiAgcmVzdWx0czoge30sXG4gIG1ldGE6IHt9LFxufTtcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gcmVkdWNlcihcbiAgc3RhdGU6IFN0YXRlPHVua25vd24+IHwgdW5kZWZpbmVkLFxuICBhY3Rpb246IEFjdGlvblR5cGVzLFxuKTogU3RhdGU8dW5rbm93bj4ge1xuICBpZiAoIXN0YXRlKSBzdGF0ZSA9IGluaXRpYWxTdGF0ZTtcbiAgc3dpdGNoIChhY3Rpb24udHlwZSkge1xuICAgIGNhc2UgJ3Jlc3QtaG9va3MvcmVjZWl2ZSc6IHtcbiAgICAgIGlmIChhY3Rpb24uZXJyb3IpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAuLi5zdGF0ZSxcbiAgICAgICAgICBtZXRhOiB7XG4gICAgICAgICAgICAuLi5zdGF0ZS5tZXRhLFxuICAgICAgICAgICAgW2FjdGlvbi5tZXRhLnVybF06IHtcbiAgICAgICAgICAgICAgZGF0ZTogYWN0aW9uLm1ldGEuZGF0ZSxcbiAgICAgICAgICAgICAgZXJyb3I6IGFjdGlvbi5wYXlsb2FkLFxuICAgICAgICAgICAgICBleHBpcmVzQXQ6IGFjdGlvbi5tZXRhLmV4cGlyZXNBdCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHsgcmVzdWx0LCBlbnRpdGllcyB9ID0gbm9ybWFsaXplKFxuICAgICAgICBhY3Rpb24ucGF5bG9hZCxcbiAgICAgICAgYWN0aW9uLm1ldGEuc2NoZW1hLFxuICAgICAgKTtcbiAgICAgIGxldCByZXN1bHRzID0ge1xuICAgICAgICAuLi5zdGF0ZS5yZXN1bHRzLFxuICAgICAgICBbYWN0aW9uLm1ldGEudXJsXTogcmVzdWx0LFxuICAgICAgfTtcbiAgICAgIHJlc3VsdHMgPSBhcHBseVVwZGF0ZXJzVG9SZXN1bHRzKHJlc3VsdHMsIHJlc3VsdCwgYWN0aW9uLm1ldGEudXBkYXRlcnMpO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgZW50aXRpZXM6IG1lcmdlRGVlcENvcHkoc3RhdGUuZW50aXRpZXMsIGVudGl0aWVzKSxcbiAgICAgICAgcmVzdWx0cyxcbiAgICAgICAgbWV0YToge1xuICAgICAgICAgIC4uLnN0YXRlLm1ldGEsXG4gICAgICAgICAgW2FjdGlvbi5tZXRhLnVybF06IHtcbiAgICAgICAgICAgIGRhdGU6IGFjdGlvbi5tZXRhLmRhdGUsXG4gICAgICAgICAgICBleHBpcmVzQXQ6IGFjdGlvbi5tZXRhLmV4cGlyZXNBdCxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICB9XG4gICAgY2FzZSAncmVzdC1ob29rcy9ycGMnOiB7XG4gICAgICBpZiAoYWN0aW9uLmVycm9yKSByZXR1cm4gc3RhdGU7XG4gICAgICBjb25zdCB7IGVudGl0aWVzLCByZXN1bHQgfSA9IG5vcm1hbGl6ZShcbiAgICAgICAgYWN0aW9uLnBheWxvYWQsXG4gICAgICAgIGFjdGlvbi5tZXRhLnNjaGVtYSxcbiAgICAgICk7XG4gICAgICBjb25zdCByZXN1bHRzID0gYXBwbHlVcGRhdGVyc1RvUmVzdWx0cyhcbiAgICAgICAgc3RhdGUucmVzdWx0cyxcbiAgICAgICAgcmVzdWx0LFxuICAgICAgICBhY3Rpb24ubWV0YS51cGRhdGVycyxcbiAgICAgICk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi5zdGF0ZSxcbiAgICAgICAgZW50aXRpZXM6IG1lcmdlRGVlcENvcHkoc3RhdGUuZW50aXRpZXMsIGVudGl0aWVzKSxcbiAgICAgICAgcmVzdWx0cyxcbiAgICAgIH07XG4gICAgfVxuICAgIGNhc2UgJ3Jlc3QtaG9va3MvcHVyZ2UnOiB7XG4gICAgICBpZiAoYWN0aW9uLmVycm9yKSByZXR1cm4gc3RhdGU7XG4gICAgICBjb25zdCBrZXkgPSBhY3Rpb24ubWV0YS5zY2hlbWEua2V5O1xuICAgICAgY29uc3QgcGsgPSBhY3Rpb24ubWV0YS51cmw7XG4gICAgICBjb25zdCBlbnRpdGllcyA9IHB1cmdlRW50aXR5KHN0YXRlLmVudGl0aWVzLCBrZXksIHBrKTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnN0YXRlLFxuICAgICAgICBlbnRpdGllcyxcbiAgICAgIH07XG4gICAgfVxuICAgIGNhc2UgJ3Jlc3QtaG9va3MvaW52YWxpZGF0ZSc6XG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi5zdGF0ZSxcbiAgICAgICAgbWV0YToge1xuICAgICAgICAgIC4uLnN0YXRlLm1ldGEsXG4gICAgICAgICAgW2FjdGlvbi5tZXRhLnVybF06IHtcbiAgICAgICAgICAgIC4uLnN0YXRlLm1ldGFbYWN0aW9uLm1ldGEudXJsXSxcbiAgICAgICAgICAgIGV4cGlyZXNBdDogMCxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICBjYXNlICdyZXN0LWhvb2tzL3Jlc2V0JzpcbiAgICAgIHJldHVybiBpbml0aWFsU3RhdGU7XG5cbiAgICBkZWZhdWx0OlxuICAgICAgLy8gSWYgJ2ZldGNoJyBhY3Rpb24gcmVhY2hlcyB0aGUgcmVkdWNlciB0aGVyZSBhcmUgbm8gbWlkZGxld2FyZXMgaW5zdGFsbGVkIHRvIGhhbmRsZSBpdFxuICAgICAgaWYgKFxuICAgICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmXG4gICAgICAgIGFjdGlvbi50eXBlID09PSAncmVzdC1ob29rcy9mZXRjaCdcbiAgICAgICkge1xuICAgICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgICAgJ1JlZHVjZXIgcmVjaWV2ZWQgZmV0Y2ggYWN0aW9uIC0geW91IGFyZSBsaWtlbHkgbWlzc2luZyB0aGUgTmV0d29ya01hbmFnZXIgbWlkZGxld2FyZScsXG4gICAgICAgICk7XG4gICAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgICAnU2VlIGh0dHBzOi8vcmVzdGhvb2tzLmlvL2RvY3MvZ3VpZGVzL3JlZHV4I2luZGV4dHN4IGZvciBob29raW5nIHVwIHJlZHV4JyxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIC8vIEEgcmVkdWNlciBtdXN0IGFsd2F5cyByZXR1cm4gYSB2YWxpZCBzdGF0ZS5cbiAgICAgIC8vIEFsdGVybmF0aXZlbHkgeW91IGNhbiB0aHJvdyBhbiBlcnJvciBpZiBhbiBpbnZhbGlkIGFjdGlvbiBpcyBkaXNwYXRjaGVkLlxuICAgICAgcmV0dXJuIHN0YXRlO1xuICB9XG59XG5cbnR5cGUgV3JpdGFibGU8VD4gPSB7IFtQIGluIGtleW9mIFRdOiBOb25OdWxsYWJsZTxUW1BdPiB9O1xuXG4vLyBlcXVpdmFsZW50IHRvIGVudGl0aWVzLmRlbGV0ZUluKGtleSwgcGspXG5mdW5jdGlvbiBwdXJnZUVudGl0eShcbiAgZW50aXRpZXM6IFN0YXRlPHVua25vd24+WydlbnRpdGllcyddLFxuICBrZXk6IHN0cmluZyxcbiAgcGs6IHN0cmluZyxcbikge1xuICBjb25zdCBjb3B5OiBXcml0YWJsZTx0eXBlb2YgZW50aXRpZXM+ID0geyAuLi5lbnRpdGllcyB9IGFzIGFueTtcbiAgY29weVtrZXldID0geyAuLi5jb3B5W2tleV0gfTtcbiAgZGVsZXRlIGNvcHlba2V5XVtwa107XG4gIHJldHVybiBjb3B5O1xufVxuIl19