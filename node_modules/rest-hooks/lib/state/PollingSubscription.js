import _toConsumableArray from "@babel/runtime/helpers/esm/toConsumableArray";
import _classCallCheck from "@babel/runtime/helpers/esm/classCallCheck";
import _createClass from "@babel/runtime/helpers/esm/createClass";
import _defineProperty from "@babel/runtime/helpers/esm/defineProperty";

/**
 * PollingSubscription keeps a given resource updated by
 * dispatching a fetch at a rate equal to the minimum update
 * interval requested.
 */
var PollingSubscription =
/*#__PURE__*/
function () {
  function PollingSubscription(_ref, dispatch) {
    var url = _ref.url,
        schema = _ref.schema,
        fetch = _ref.fetch,
        frequency = _ref.frequency;

    _classCallCheck(this, PollingSubscription);

    _defineProperty(this, "schema", void 0);

    _defineProperty(this, "fetch", void 0);

    _defineProperty(this, "url", void 0);

    _defineProperty(this, "frequency", void 0);

    _defineProperty(this, "frequencyHistogram", new Map());

    _defineProperty(this, "dispatch", void 0);

    _defineProperty(this, "intervalId", void 0);

    _defineProperty(this, "lastIntervalId", void 0);

    if (frequency === undefined) throw new Error('frequency needed for polling subscription');
    this.schema = schema;
    this.fetch = fetch;
    this.frequency = frequency;
    this.url = url;
    this.frequencyHistogram.set(this.frequency, 1);
    this.dispatch = dispatch;
    this.run();
  }
  /** Subscribe to a frequency */


  _createClass(PollingSubscription, [{
    key: "add",
    value: function add(frequency) {
      if (frequency === undefined) return;

      if (this.frequencyHistogram.has(frequency)) {
        this.frequencyHistogram.set(frequency, this.frequencyHistogram.get(frequency) + 1);
      } else {
        this.frequencyHistogram.set(frequency, 1); // new min so restart service

        if (frequency < this.frequency) {
          this.frequency = frequency;
          this.run();
        }
      }
    }
    /** Unsubscribe from a frequency */

  }, {
    key: "remove",
    value: function remove(frequency) {
      if (frequency === undefined) return false;

      if (this.frequencyHistogram.has(frequency)) {
        this.frequencyHistogram.set(frequency, this.frequencyHistogram.get(frequency) - 1);

        if (this.frequencyHistogram.get(frequency) < 1) {
          this.frequencyHistogram["delete"](frequency); // nothing subscribed to this anymore...it is invalid

          if (this.frequencyHistogram.size === 0) {
            this.cleanup();
            return true;
          } // this was the min, so find the next size


          if (frequency <= this.frequency) {
            this.frequency = Math.min.apply(Math, _toConsumableArray(this.frequencyHistogram.keys()));
            this.run();
          }
        }
      } else if (process.env.NODE_ENV !== 'production') {
        console.error("Mismatched remove: ".concat(frequency, " is not subscribed for ").concat(this.url));
      }

      return false;
    }
    /** Cleanup means clearing out background interval. */

  }, {
    key: "cleanup",
    value: function cleanup() {
      if (this.intervalId) {
        clearInterval(this.intervalId);
        this.intervalId = undefined;
      }

      if (this.lastIntervalId) {
        clearInterval(this.lastIntervalId);
        this.lastIntervalId = undefined;
      }
    }
    /** Trigger request for latest resource */

  }, {
    key: "update",
    value: function update() {
      this.dispatch({
        type: 'rest-hooks/fetch',
        payload: this.fetch,
        meta: {
          schema: this.schema,
          url: this.url,
          responseType: 'rest-hooks/receive',
          throttle: true,
          options: {
            dataExpiryLength: this.frequency / 2,
            errorExpiryLength: this.frequency / 10
          },
          resolve: function resolve() {},
          reject: function reject() {}
        }
      });
    }
    /** Run polling process with current frequency
     *
     * Will clean up old poll interval on next run
     */

  }, {
    key: "run",
    value: function run() {
      var _this = this;

      this.lastIntervalId = this.intervalId;
      this.intervalId = setInterval(function () {
        // since we don't know how long into the last poll it was before resetting
        // we wait til the next fetch to clear old intervals
        if (_this.lastIntervalId) {
          clearInterval(_this.lastIntervalId);
          _this.lastIntervalId = undefined;
        }

        _this.update();
      }, this.frequency);
    }
  }]);

  return PollingSubscription;
}();

export { PollingSubscription as default };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdGF0ZS9Qb2xsaW5nU3Vic2NyaXB0aW9uLnRzIl0sIm5hbWVzIjpbIlBvbGxpbmdTdWJzY3JpcHRpb24iLCJkaXNwYXRjaCIsInVybCIsInNjaGVtYSIsImZldGNoIiwiZnJlcXVlbmN5IiwiTWFwIiwidW5kZWZpbmVkIiwiRXJyb3IiLCJmcmVxdWVuY3lIaXN0b2dyYW0iLCJzZXQiLCJydW4iLCJoYXMiLCJnZXQiLCJzaXplIiwiY2xlYW51cCIsIk1hdGgiLCJtaW4iLCJrZXlzIiwicHJvY2VzcyIsImVudiIsIk5PREVfRU5WIiwiY29uc29sZSIsImVycm9yIiwiaW50ZXJ2YWxJZCIsImNsZWFySW50ZXJ2YWwiLCJsYXN0SW50ZXJ2YWxJZCIsInR5cGUiLCJwYXlsb2FkIiwibWV0YSIsInJlc3BvbnNlVHlwZSIsInRocm90dGxlIiwib3B0aW9ucyIsImRhdGFFeHBpcnlMZW5ndGgiLCJlcnJvckV4cGlyeUxlbmd0aCIsInJlc29sdmUiLCJyZWplY3QiLCJzZXRJbnRlcnZhbCIsInVwZGF0ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFJQTs7Ozs7SUFLcUJBLG1COzs7QUFVbkIscUNBRUVDLFFBRkYsRUFHRTtBQUFBLFFBRkVDLEdBRUYsUUFGRUEsR0FFRjtBQUFBLFFBRk9DLE1BRVAsUUFGT0EsTUFFUDtBQUFBLFFBRmVDLEtBRWYsUUFGZUEsS0FFZjtBQUFBLFFBRnNCQyxTQUV0QixRQUZzQkEsU0FFdEI7O0FBQUE7O0FBQUE7O0FBQUE7O0FBQUE7O0FBQUE7O0FBQUEsZ0RBUmtELElBQUlDLEdBQUosRUFRbEQ7O0FBQUE7O0FBQUE7O0FBQUE7O0FBQ0EsUUFBSUQsU0FBUyxLQUFLRSxTQUFsQixFQUNFLE1BQU0sSUFBSUMsS0FBSixDQUFVLDJDQUFWLENBQU47QUFDRixTQUFLTCxNQUFMLEdBQWNBLE1BQWQ7QUFDQSxTQUFLQyxLQUFMLEdBQWFBLEtBQWI7QUFDQSxTQUFLQyxTQUFMLEdBQWlCQSxTQUFqQjtBQUNBLFNBQUtILEdBQUws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QUFnQixFQUFFLEtBQUs1QixTQUFMLEdBQWlCLENBRDVCO0FBRVA2QixZQUFBQSxpQkFBaUIsRUFBRSxLQUFLN0IsU0FBTCxHQUFpQjtBQUY3QixXQUxMO0FBU0o4QixVQUFBQSxPQUFPLEVBQUUsbUJBQU0sQ0FBRSxDQVRiO0FBVUpDLFVBQUFBLE1BQU0sRUFBRSxrQkFBTSxDQUFFO0FBVlo7QUFITSxPQUFkO0FBZ0JEO0FBRUQ7Ozs7Ozs7MEJBSWdCO0FBQUE7O0FBQ2QsV0FBS1YsY0FBTCxHQUFzQixLQUFLRixVQUEzQjtBQUNBLFdBQUtBLFVBQUwsR0FBa0JhLFdBQVcsQ0FBQyxZQUFNO0FBQ2xDO0FBQ0E7QUFDQSxZQUFJLEtBQUksQ0FBQ1gsY0FBVCxFQUF5QjtBQUN2QkQsVUFBQUEsYUFBYSxDQUFDLEtBQUksQ0FBQ0MsY0FBTixDQUFiO0FBQ0EsVUFBQSxLQUFJLENBQUNBLGNBQUwsR0FBc0JuQixTQUF0QjtBQUNEOztBQUNELFFBQUEsS0FBSSxDQUFDK0IsTUFBTDtBQUNELE9BUjRCLEVBUTFCLEtBQUtqQyxTQVJxQixDQUE3QjtBQVNEOzs7Ozs7U0ExSGtCTCxtQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFNjaGVtYSB9IGZyb20gJ34vcmVzb3VyY2UnO1xuaW1wb3J0IHsgRGlzcGF0Y2ggfSBmcm9tICd+L3R5cGVzJztcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiwgU3Vic2NyaXB0aW9uSW5pdCB9IGZyb20gJy4vU3Vic2NyaXB0aW9uTWFuYWdlcic7XG5cbi8qKlxuICogUG9sbGluZ1N1YnNjcmlwdGlvbiBrZWVwcyBhIGdpdmVuIHJlc291cmNlIHVwZGF0ZWQgYnlcbiAqIGRpc3BhdGNoaW5nIGEgZmV0Y2ggYXQgYSByYXRlIGVxdWFsIHRvIHRoZSBtaW5pbXVtIHVwZGF0ZVxuICogaW50ZXJ2YWwgcmVxdWVzdGVkLlxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBQb2xsaW5nU3Vic2NyaXB0aW9uIGltcGxlbWVudHMgU3Vic2NyaXB0aW9uIHtcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IHNjaGVtYTogU2NoZW1hO1xuICBwcm90ZWN0ZWQgcmVhZG9ubHkgZmV0Y2g6ICgpID0+IFByb21pc2U8YW55PjtcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IHVybDogc3RyaW5nO1xuICBwcm90ZWN0ZWQgZnJlcXVlbmN5OiBudW1iZXI7XG4gIHByb3RlY3RlZCBmcmVxdWVuY3lIaXN0b2dyYW06IE1hcDxudW1iZXIsIG51bWJlcj4gPSBuZXcgTWFwKCk7XG4gIHByb3RlY3RlZCBkaXNwYXRjaDogRGlzcGF0Y2g8YW55PjtcbiAgcHJvdGVjdGVkIGludGVydmFsSWQ/OiBOb2RlSlMuVGltZW91dDtcbiAgcHJvdGVjdGVkIGxhc3RJbnRlcnZhbElkPzogTm9kZUpTLlRpbWVvdXQ7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgeyB1cmwsIHNjaGVtYSwgZmV0Y2gsIGZyZXF1ZW5jeSB9OiBTdWJzY3JpcHRpb25Jbml0LFxuICAgIGRpc3BhdGNoOiBEaXNwYXRjaDxhbnk+LFxuICApIHtcbiAgICBpZiAoZnJlcXVlbmN5ID09PSB1bmRlZmluZWQpXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ZyZXF1ZW5jeSBuZWVkZWQgZm9yIHBvbGxpbmcgc3Vic2NyaXB0aW9uJyk7XG4gICAgdGhpcy5zY2hlbWEgPSBzY2hlbWE7XG4gICAgdGhpcy5mZXRjaCA9IGZldGNoO1xuICAgIHRoaXMuZnJlcXVlbmN5ID0gZnJlcXVlbmN5O1xuICAgIHRoaXMudXJsID0gdXJsO1xuICAgIHRoaXMuZnJlcXVlbmN5SGlzdG9ncmFtLnNldCh0aGlzLmZyZXF1ZW5jeSwgMSk7XG4gICAgdGhpcy5kaXNwYXRjaCA9IGRpc3BhdGNoO1xuICAgIHRoaXMucnVuKCk7XG4gIH1cblxuICAvKiogU3Vic2NyaWJlIHRvIGEgZnJlcXVlbmN5ICovXG4gIGFkZChmcmVxdWVuY3k/OiBudW1iZXIpIHtcbiAgICBpZiAoZnJlcXVlbmN5ID09PSB1bmRlZmluZWQpIHJldHVybjtcbiAgICBpZiAodGhpcy5mcmVxdWVuY3lIaXN0b2dyYW0uaGFzKGZyZXF1ZW5jeSkpIHtcbiAgICAgIHRoaXMuZnJlcXVlbmN5SGlzdG9ncmFtLnNldChcbiAgICAgICAgZnJlcXVlbmN5LFxuICAgICAgICAodGhpcy5mcmVxdWVuY3lIaXN0b2dyYW0uZ2V0KGZyZXF1ZW5jeSkgYXMgbnVtYmVyKSArIDEsXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmZyZXF1ZW5jeUhpc3RvZ3JhbS5zZXQoZnJlcXVlbmN5LCAxKTtcblxuICAgICAgLy8gbmV3IG1pbiBzbyByZXN0YXJ0IHNlcnZpY2VcbiAgICAgIGlmIChmcmVxdWVuY3kgPCB0aGlzLmZyZXF1ZW5jeSkge1xuICAgICAgICB0aGlzLmZyZXF1ZW5jeSA9IGZyZXF1ZW5jeTtcbiAgICAgICAgdGhpcy5ydW4oKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKiogVW5zdWJzY3JpYmUgZnJvbSBhIGZyZXF1ZW5jeSAqL1xuICByZW1vdmUoZnJlcXVlbmN5PzogbnVtYmVyKSB7XG4gICAgaWYgKGZyZXF1ZW5jeSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gZmFsc2U7XG4gICAgaWYgKHRoaXMuZnJlcXVlbmN5SGlzdG9ncmFtLmhhcyhmcmVxdWVuY3kpKSB7XG4gICAgICB0aGlzLmZyZXF1ZW5jeUhpc3RvZ3JhbS5zZXQoXG4gICAgICAgIGZyZXF1ZW5jeSxcbiAgICAgICAgKHRoaXMuZnJlcXVlbmN5SGlzdG9ncmFtLmdldChmcmVxdWVuY3kpIGFzIG51bWJlcikgLSAxLFxuICAgICAgKTtcbiAgICAgIGlmICgodGhpcy5mcmVxdWVuY3lIaXN0b2dyYW0uZ2V0KGZyZXF1ZW5jeSkgYXMgbnVtYmVyKSA8IDEpIHtcbiAgICAgICAgdGhpcy5mcmVxdWVuY3lIaXN0b2dyYW0uZGVsZXRlKGZyZXF1ZW5jeSk7XG5cbiAgICAgICAgLy8gbm90aGluZyBzdWJzY3JpYmVkIHRvIHRoaXMgYW55bW9yZS4uLml0IGlzIGludmFsaWRcbiAgICAgICAgaWYgKHRoaXMuZnJlcXVlbmN5SGlzdG9ncmFtLnNpemUgPT09IDApIHtcbiAgICAgICAgICB0aGlzLmNsZWFudXAoKTtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHRoaXMgd2FzIHRoZSBtaW4sIHNvIGZpbmQgdGhlIG5leHQgc2l6ZVxuICAgICAgICBpZiAoZnJlcXVlbmN5IDw9IHRoaXMuZnJlcXVlbmN5KSB7XG4gICAgICAgICAgdGhpcy5mcmVxdWVuY3kgPSBNYXRoLm1pbiguLi50aGlzLmZyZXF1ZW5jeUhpc3RvZ3JhbS5rZXlzKCkpO1xuICAgICAgICAgIHRoaXMucnVuKCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgIGBNaXNtYXRjaGVkIHJlbW92ZTogJHtmcmVxdWVuY3l9IGlzIG5vdCBzdWJzY3JpYmVkIGZvciAke3RoaXMudXJsfWAsXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvKiogQ2xlYW51cCBtZWFucyBjbGVhcmluZyBvdXQgYmFja2dyb3VuZCBpbnRlcnZhbC4gKi9cbiAgY2xlYW51cCgpIHtcbiAgICBpZiAodGhpcy5pbnRlcnZhbElkKSB7XG4gICAgICBjbGVhckludGVydmFsKHRoaXMuaW50ZXJ2YWxJZCk7XG4gICAgICB0aGlzLmludGVydmFsSWQgPSB1bmRlZmluZWQ7XG4gICAgfVxuICAgIGlmICh0aGlzLmxhc3RJbnRlcnZhbElkKSB7XG4gICAgICBjbGVhckludGVydmFsKHRoaXMubGFzdEludGVydmFsSWQpO1xuICAgICAgdGhpcy5sYXN0SW50ZXJ2YWxJZCA9IHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICAvKiogVHJpZ2dlciByZXF1ZXN0IGZvciBsYXRlc3QgcmVzb3VyY2UgKi9cbiAgcHJvdGVjdGVkIHVwZGF0ZSgpIHtcbiAgICB0aGlzLmRpc3BhdGNoKHtcbiAgICAgIHR5cGU6ICdyZXN0LWhvb2tzL2ZldGNoJyxcbiAgICAgIHBheWxvYWQ6IHRoaXMuZmV0Y2gsXG4gICAgICBtZXRhOiB7XG4gICAgICAgIHNjaGVtYTogdGhpcy5zY2hlbWEsXG4gICAgICAgIHVybDogdGhpcy51cmwsXG4gICAgICAgIHJlc3BvbnNlVHlwZTogJ3Jlc3QtaG9va3MvcmVjZWl2ZScsXG4gICAgICAgIHRocm90dGxlOiB0cnVlLFxuICAgICAgICBvcHRpb25zOiB7XG4gICAgICAgICAgZGF0YUV4cGlyeUxlbmd0aDogdGhpcy5mcmVxdWVuY3kgLyAyLFxuICAgICAgICAgIGVycm9yRXhwaXJ5TGVuZ3RoOiB0aGlzLmZyZXF1ZW5jeSAvIDEwLFxuICAgICAgICB9LFxuICAgICAgICByZXNvbHZlOiAoKSA9PiB7fSxcbiAgICAgICAgcmVqZWN0OiAoKSA9PiB7fSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICAvKiogUnVuIHBvbGxpbmcgcHJvY2VzcyB3aXRoIGN1cnJlbnQgZnJlcXVlbmN5XG4gICAqXG4gICAqIFdpbGwgY2xlYW4gdXAgb2xkIHBvbGwgaW50ZXJ2YWwgb24gbmV4dCBydW5cbiAgICovXG4gIHByb3RlY3RlZCBydW4oKSB7XG4gICAgdGhpcy5sYXN0SW50ZXJ2YWxJZCA9IHRoaXMuaW50ZXJ2YWxJZDtcbiAgICB0aGlzLmludGVydmFsSWQgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAvLyBzaW5jZSB3ZSBkb24ndCBrbm93IGhvdyBsb25nIGludG8gdGhlIGxhc3QgcG9sbCBpdCB3YXMgYmVmb3JlIHJlc2V0dGluZ1xuICAgICAgLy8gd2Ugd2FpdCB0aWwgdGhlIG5leHQgZmV0Y2ggdG8gY2xlYXIgb2xkIGludGVydmFsc1xuICAgICAgaWYgKHRoaXMubGFzdEludGVydmFsSWQpIHtcbiAgICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLmxhc3RJbnRlcnZhbElkKTtcbiAgICAgICAgdGhpcy5sYXN0SW50ZXJ2YWxJZCA9IHVuZGVmaW5lZDtcbiAgICAgIH1cbiAgICAgIHRoaXMudXBkYXRlKCk7XG4gICAgfSwgdGhpcy5mcmVxdWVuY3kpO1xuICB9XG59XG4iXX0=