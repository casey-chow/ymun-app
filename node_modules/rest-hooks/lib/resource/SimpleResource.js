import _classCallCheck from "@babel/runtime/helpers/esm/classCallCheck";
import _createClass from "@babel/runtime/helpers/esm/createClass";
import _defineProperty from "@babel/runtime/helpers/esm/defineProperty";
import _memoize from "lodash/memoize";
import { schemas } from './normal';
var DefinedMembersKey = Symbol('Defined Members');

/** Represents an entity to be retrieved from a server. Typically 1:1 with a url endpoint. */
var SimpleResource =
/*#__PURE__*/
function () {
  function SimpleResource() {
    _classCallCheck(this, SimpleResource);

    _defineProperty(this, "__url", void 0);
  }

  _createClass(SimpleResource, [{
    key: "url",

    /** URL to find this SimpleResource */
    get: function get() {
      if (this.__url !== undefined) return this.__url; // typescript thinks constructor is just a function

      var Static = this.constructor;
      return Static.url(this);
    }
  }], [{
    key: "fromJS",

    /** SimpleResource factory. Takes an object of properties to assign to SimpleResource. */
    value: function fromJS(props) {
      // we type guarded abstract case above, so ok to force typescript to allow constructor call
      var instance = new this(props);
      if (instance.pk === undefined) throw new Error('cannot construct on abstract types');
      Object.defineProperty(instance, DefinedMembersKey, {
        value: Object.keys(props),
        writable: false
      });
      Object.assign(instance, props); // to trick normalizr into thinking we're Immutable.js does it doesn't copy

      Object.defineProperty(instance, '__ownerID', {
        value: 1337,
        writable: false
      });
      return instance;
    }
    /** Creates new instance copying over defined values of arguments */

  }, {
    key: "merge",
    value: function merge(first, second) {
      var props = Object.assign({}, this.toObjectDefined(first), this.toObjectDefined(second));
      return this.fromJS(props);
    }
    /** Whether key is non-default */

  }, {
    key: "hasDefined",
    value: function hasDefined(instance, key) {
      return instance[DefinedMembersKey].includes(key);
    }
    /** Returns simple object with all the non-default members */

  }, {
    key: "toObjectDefined",
    value: function toObjectDefined(instance) {
      var defined = {};
      var _iteratorNormalCompletion = true;
      var _didIteratorError = false;
      var _iteratorError = undefined;

      try {
        for (var _iterator = instance[DefinedMembersKey][Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          var member = _step.value;
          defined[member] = instance[member];
        }
      } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion && _iterator["return"] != null) {
            _iterator["return"]();
          }
        } finally {
          if (_didIteratorError) {
            throw _iteratorError;
          }
        }
      }

      return defined;
    }
    /** Returns array of all keys that have values defined in instance */

  }, {
    key: "keysDefined",
    value: function keysDefined(instance) {
      return instance[DefinedMembersKey];
    }
  }, {
    key: "toString",
    value: function toString() {
      return "".concat(this.name, "::").concat(this.urlRoot);
    }
    /** Returns the globally unique identifier for this SimpleResource */

  }, {
    key: "getKey",
    value: function getKey() {
      return this.urlRoot;
    }
    /** A unique identifier for this SimpleResource */

  }, {
    key: "pk",
    value: function pk(params) {
      return this.prototype.pk.call(params);
    }
  }, {
    key: "url",

    /** Get the url for a SimpleResource
     *
     * Default implementation conforms to common REST patterns
     */
    value: function url(urlParams) {
      if (urlParams) {
        if (Object.prototype.hasOwnProperty.call(urlParams, 'url') && urlParams.url && typeof urlParams.url === 'string') {
          return urlParams.url;
        }

        if (this.pk(urlParams) !== null) {
          if (this.urlRoot.endsWith('/')) {
            return "".concat(this.urlRoot).concat(this.pk(urlParams));
          }

          return "".concat(this.urlRoot, "/").concat(this.pk(urlParams));
        }
      }

      return this.urlRoot;
    }
    /** Get the url for many SimpleResources
     *
     * Default implementation conforms to common REST patterns
     */

  }, {
    key: "listUrl",
    value: function listUrl(searchParams) {
      if (searchParams && Object.keys(searchParams).length) {
        var params = new URLSearchParams(searchParams);
        params.sort();
        return "".concat(this.urlRoot, "?").concat(params.toString());
      }

      return this.urlRoot;
    }
    /** Perform network request and resolve with json body */

  }, {
    key: "fetch",
    value: function fetch(method, url, body) {
      // typescript currently doesn't allow abstract static methods
      throw new Error('not implemented');
    }
    /** Get the entity schema defining  */

  }, {
    key: "getEntitySchema",
    value: function getEntitySchema() {
      return _getEntitySchema(this);
    }
    /** Get the request options for this SimpleResource  */

  }, {
    key: "getFetchOptions",
    value: function getFetchOptions() {
      return;
    } // TODO: memoize these so they can be referentially compared

    /** Shape to get a single entity */

  }, {
    key: "detailShape",
    value: function detailShape() {
      var _this = this;

      var getFetchKey = function getFetchKey(params) {
        return 'GET ' + _this.url(params);
      };

      var schema = this.getEntitySchema();
      var options = this.getFetchOptions();
      return {
        type: 'read',
        schema: schema,
        options: options,
        getFetchKey: getFetchKey,
        fetch: function fetch(params) {
          return _this.fetch('get', _this.url(params));
        }
      };
    }
    /** Shape to get a list of entities */

  }, {
    key: "listShape",
    value: function listShape() {
      var _this2 = this;

      var getFetchKey = function getFetchKey(params) {
        return 'GET ' + _this2.listUrl(params);
      };

      var schema = [this.getEntitySchema()];
      var options = this.getFetchOptions();
      return {
        type: 'read',
        schema: schema,
        options: options,
        getFetchKey: getFetchKey,
        fetch: function fetch(params) {
          return _this2.fetch('get', _this2.listUrl(params));
        }
      };
    }
    /** Shape to create a new entity (post) */

  }, {
    key: "createShape",
    value: function createShape() {
      var _this3 = this;

      var options = this.getFetchOptions();
      return {
        type: 'mutate',
        schema: this.getEntitySchema(),
        options: options,
        getFetchKey: function getFetchKey(params) {
          return 'POST ' + _this3.listUrl(params);
        },
        fetch: function fetch(params, body) {
          return _this3.fetch('post', _this3.listUrl(params), body);
        }
      };
    }
    /** Shape to update an existing entity (put) */

  }, {
    key: "updateShape",
    value: function updateShape() {
      var _this4 = this;

      var options = this.getFetchOptions();
      return {
        type: 'mutate',
        schema: this.getEntitySchema(),
        options: options,
        getFetchKey: function getFetchKey(params) {
          return 'PUT ' + _this4.url(params);
        },
        fetch: function fetch(params, body) {
          return _this4.fetch('put', _this4.url(params), body);
        }
      };
    }
    /** Shape to update a subset of fields of an existing entity (patch) */

  }, {
    key: "partialUpdateShape",
    value: function partialUpdateShape() {
      var _this5 = this;

      var options = this.getFetchOptions();
      return {
        type: 'mutate',
        schema: this.getEntitySchema(),
        //TODO: change merge strategy in case we want to handle partial returns
        options: options,
        getFetchKey: function getFetchKey(params) {
          return 'PATCH ' + _this5.url(params);
        },
        fetch: function fetch(params, body) {
          return _this5.fetch('patch', _this5.url(params), body);
        }
      };
    }
    /** Shape to delete an entity (delete) */

  }, {
    key: "deleteShape",
    value: function deleteShape() {
      var _this6 = this;

      var options = this.getFetchOptions();
      return {
        type: 'delete',
        schema: this.getEntitySchema(),
        options: options,
        getFetchKey: function getFetchKey(params) {
          return 'DELETE ' + _this6.url(params);
        },
        fetch: function fetch(params) {
          return _this6.fetch('delete', _this6.url(params));
        }
      };
    }
  }]);

  return SimpleResource;
}(); // We're only allowing this to get set for descendants but
// by default we want Typescript to treat it as readonly.


_defineProperty(SimpleResource, "urlRoot", void 0);

export { SimpleResource as default };
Object.defineProperty(SimpleResource.prototype, 'url', {
  set: function set(url) {
    this.__url = url;
  }
});

var _getEntitySchema = _memoize(function (ResourceClass) {
  var e = new schemas.Entity(ResourceClass.getKey(), {}, {
    idAttribute: function idAttribute(value, parent, key) {
      var id = ResourceClass.pk(value) || key;

      if (process.env.NODE_ENV !== 'production' && id === null) {
        throw new Error("Missing usable resource key when normalizing response.\n\nThis is likely due to a malformed response.\nTry inspecting the network response or fetch() return value.\n");
      }

      return id.toString();
    },
    processStrategy: function processStrategy(value) {
      return ResourceClass.fromJS(value);
    },
    mergeStrategy: function mergeStrategy(a, b) {
      return a.constructor.merge(a, b);
    }
  }); // TODO: long term figure out a plan to actually denormalize

  e.denormalize = function denormalize(entity) {
    return [entity, true];
  };

  return e;
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yZXNvdXJjZS9TaW1wbGVSZXNvdXJjZS50cyJdLCJuYW1lcyI6WyJzY2hlbWFzIiwiRGVmaW5lZE1lbWJlcnNLZXkiLCJTeW1ib2wiLCJTaW1wbGVSZXNvdXJjZSIsIl9fdXJsIiwidW5kZWZpbmVkIiwiU3RhdGljIiwiY29uc3RydWN0b3IiLCJ1cmwiLCJwcm9wcyIsImluc3RhbmNlIiwicGsiLCJFcnJvciIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwidmFsdWUiLCJrZXlzIiwid3JpdGFibGUiLCJhc3NpZ24iLCJmaXJzdCIsInNlY29uZCIsInRvT2JqZWN0RGVmaW5lZCIsImZyb21KUyIsImtleSIsImluY2x1ZGVzIiwiZGVmaW5lZCIsIm1lbWJlciIsIm5hbWUiLCJ1cmxSb290IiwicGFyYW1zIiwicHJvdG90eXBlIiwiY2FsbCIsInVybFBhcmFtcyIsImhhc093blByb3BlcnR5IiwiZW5kc1dpdGgiLCJzZWFyY2hQYXJhbXMiLCJsZW5ndGgiLCJVUkxTZWFyY2hQYXJhbXMiLCJzb3J0IiwidG9TdHJpbmciLCJtZXRob2QiLCJib2R5IiwiZ2V0RW50aXR5U2NoZW1hIiwiZ2V0RmV0Y2hLZXkiLCJzY2hlbWEiLCJvcHRpb25zIiwiZ2V0RmV0Y2hPcHRpb25zIiwidHlwZSIsImZldGNoIiwibGlzdFVybCIsInNldCIsIlJlc291cmNlQ2xhc3MiLCJlIiwiRW50aXR5IiwiZ2V0S2V5IiwiaWRBdHRyaWJ1dGUiLCJwYXJlbnQiLCJpZCIsInByb2Nlc3MiLCJlbnYiLCJOT0RFX0VOViIsInByb2Nlc3NTdHJhdGVneSIsIm1lcmdlU3RyYXRlZ3kiLCJhIiwiYiIsIm1lcmdlIiwiZGVub3JtYWxpemUiLCJlbnRpdHkiXSwibWFwcGluZ3MiOiI7Ozs7QUFJQSxTQUFTQSxPQUFULFFBQWtELFVBQWxEO0FBRUEsSUFBTUMsaUJBQWlCLEdBQUdDLE1BQU0sQ0FBQyxpQkFBRCxDQUFoQzs7QUFNQTtJQUM4QkMsYzs7Ozs7Ozs7Ozs7O0FBbUc1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Q0csTUFBZCxFQURRLEVBRVIsRUFGUSxFQUdSO0FBQ0VDLElBQUFBLFdBQVcsRUFBRSxxQkFBQ3hDLEtBQUQsRUFBUXlDLE1BQVIsRUFBZ0JqQyxHQUFoQixFQUF3QjtBQUNuQyxVQUFNa0MsRUFBRSxHQUFHTixhQUFhLENBQUN4QyxFQUFkLENBQWlCSSxLQUFqQixLQUEyQlEsR0FBdEM7O0FBQ0EsVUFBSW1DLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxRQUFaLEtBQXlCLFlBQXpCLElBQXlDSCxFQUFFLEtBQUssSUFBcEQsRUFBMEQ7QUFDeEQsY0FBTSxJQUFJN0MsS0FBSix5S0FBTjtBQU9EOztBQUNELGFBQU82QyxFQUFFLENBQUNsQixRQUFILEVBQVA7QUFDRCxLQWJIO0FBY0VzQixJQUFBQSxlQUFlLEVBQUUseUJBQUE5QyxLQUFLLEVBQUk7QUFDeEIsYUFBT29DLGFBQWEsQ0FBQzdCLE1BQWQsQ0FBcUJQLEtBQXJCLENBQVA7QUFDRCxLQWhCSDtBQWlCRStDLElBQUFBLGFBQWEsRUFBRSx1QkFDYkMsQ0FEYSxFQUViQyxDQUZhO0FBQUEsYUFHVEQsQ0FBQyxDQUFDeEQsV0FBSCxDQUFxQjBELEtBQXJCLENBQTJCRixDQUEzQixFQUE4QkMsQ0FBOUIsQ0FIVTtBQUFBO0FBakJqQixHQUhRLENBQVYsQ0FEcUQsQ0EyQnJEOztBQUNDWixFQUFBQSxDQUFELENBQVdjLFdBQVgsR0FBeUIsU0FBU0EsV0FBVCxDQUFxQkMsTUFBckIsRUFBa0M7QUFDekQsV0FBTyxDQUFDQSxNQUFELEVBQVMsSUFBVCxDQUFQO0FBQ0QsR0FGRDs7QUFHQSxTQUFPZixDQUFQO0FBQ0QsQ0FqQ3NDLENBQXpDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgbWVtb2l6ZSB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBBYnN0cmFjdEluc3RhbmNlVHlwZSwgTWV0aG9kLCBGZXRjaE9wdGlvbnMgfSBmcm9tICd+L3R5cGVzJztcblxuaW1wb3J0IHsgUmVhZFNoYXBlLCBNdXRhdGVTaGFwZSwgRGVsZXRlU2hhcGUgfSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB7IHNjaGVtYXMsIFNjaGVtYURldGFpbCwgU2NoZW1hTGlzdCB9IGZyb20gJy4vbm9ybWFsJztcblxuY29uc3QgRGVmaW5lZE1lbWJlcnNLZXkgPSBTeW1ib2woJ0RlZmluZWQgTWVtYmVycycpO1xudHlwZSBGaWx0ZXI8VCwgVT4gPSBUIGV4dGVuZHMgVSA/IFQgOiBuZXZlcjtcbmludGVyZmFjZSBTaW1wbGVSZXNvdXJjZU1lbWJlcnM8VCBleHRlbmRzIHR5cGVvZiBTaW1wbGVSZXNvdXJjZT4ge1xuICBbRGVmaW5lZE1lbWJlcnNLZXldOiAoRmlsdGVyPGtleW9mIEFic3RyYWN0SW5zdGFuY2VUeXBlPFQ+LCBzdHJpbmc+KVtdO1xufVxuXG4vKiogUmVwcmVzZW50cyBhbiBlbnRpdHkgdG8gYmUgcmV0cmlldmVkIGZyb20gYSBzZXJ2ZXIuIFR5cGljYWxseSAxOjEgd2l0aCBhIHVybCBlbmRwb2ludC4gKi9cbmV4cG9ydCBkZWZhdWx0IGFic3RyYWN0IGNsYXNzIFNpbXBsZVJlc291cmNlIHtcbiAgLy8gdHlwZXNjcmlwdCB0b2RvOiByZXF1aXJlIHN1YmNsYXNzZXMgdG8gaW1wbGVtZW50XG4gIC8qKiBVc2VkIGFzIGJhc2Ugb2YgdXJsIGNvbnN0cnVjdGlvbiAqL1xuICBzdGF0aWMgcmVhZG9ubHkgdXJsUm9vdDogc3RyaW5nO1xuICAvKiogQSB1bmlxdWUgaWRlbnRpZmllciBmb3IgdGhpcyBTaW1wbGVSZXNvdXJjZSAqL1xuICBhYnN0cmFjdCBwaygpOiBzdHJpbmcgfCBudW1iZXIgfCB1bmRlZmluZWQ7XG5cbiAgLyoqIFNpbXBsZVJlc291cmNlIGZhY3RvcnkuIFRha2VzIGFuIG9iamVjdCBvZiBwcm9wZXJ0aWVzIHRvIGFzc2lnbiB0byBTaW1wbGVSZXNvdXJjZS4gKi9cbiAgc3RhdGljIGZyb21KUzxUIGV4dGVuZHMgdHlwZW9mIFNpbXBsZVJlc291cmNlPihcbiAgICB0aGlzOiBULFxuICAgIHByb3BzOiBQYXJ0aWFsPEFic3RyYWN0SW5zdGFuY2VUeXBlPFQ+PixcbiAgKSB7XG4gICAgLy8gd2UgdHlwZSBndWFyZGVkIGFic3RyYWN0IGNhc2UgYWJvdmUsIHNvIG9rIHRvIGZvcmNlIHR5cGVzY3JpcHQgdG8gYWxsb3cgY29uc3RydWN0b3IgY2FsbFxuICAgIGNvbnN0IGluc3RhbmNlID0gbmV3ICh0aGlzIGFzIGFueSkocHJvcHMpIGFzIFJlYWRvbmx5PFxuICAgICAgQWJzdHJhY3RJbnN0YW5jZVR5cGU8VD5cbiAgICA+O1xuXG4gICAgaWYgKGluc3RhbmNlLnBrID09PSB1bmRlZmluZWQpXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2Nhbm5vdCBjb25zdHJ1Y3Qgb24gYWJzdHJhY3QgdHlwZXMnKTtcblxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShpbnN0YW5jZSwgRGVmaW5lZE1lbWJlcnNLZXksIHtcbiAgICAgIHZhbHVlOiBPYmplY3Qua2V5cyhwcm9wcyksXG4gICAgICB3cml0YWJsZTogZmFsc2UsXG4gICAgfSk7XG5cbiAgICBPYmplY3QuYXNzaWduKGluc3RhbmNlLCBwcm9wcyk7XG5cbiAgICAvLyB0byB0cmljayBub3JtYWxpenIgaW50byB0aGlua2luZyB3ZSdyZSBJbW11dGFibGUuanMgZG9lcyBpdCBkb2Vzbid0IGNvcHlcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoaW5zdGFuY2UsICdfX293bmVySUQnLCB7XG4gICAgICB2YWx1ZTogMTMzNyxcbiAgICAgIHdyaXRhYmxlOiBmYWxzZSxcbiAgICB9KTtcbiAgICByZXR1cm4gaW5zdGFuY2U7XG4gIH1cblxuICAvKiogQ3JlYXRlcyBuZXcgaW5zdGFuY2UgY29weWluZyBvdmVyIGRlZmluZWQgdmFsdWVzIG9mIGFyZ3VtZW50cyAqL1xuICBzdGF0aWMgbWVyZ2U8VCBleHRlbmRzIHR5cGVvZiBTaW1wbGVSZXNvdXJjZT4oXG4gICAgdGhpczogVCxcbiAgICBmaXJzdDogQWJzdHJhY3RJbnN0YW5jZVR5cGU8VD4sXG4gICAgc2Vjb25kOiBBYnN0cmFjdEluc3RhbmNlVHlwZTxUPixcbiAgKSB7XG4gICAgY29uc3QgcHJvcHMgPSBPYmplY3QuYXNzaWduKFxuICAgICAge30sXG4gICAgICB0aGlzLnRvT2JqZWN0RGVmaW5lZChmaXJzdCksXG4gICAgICB0aGlzLnRvT2JqZWN0RGVmaW5lZChzZWNvbmQpLFxuICAgICk7XG4gICAgcmV0dXJuIHRoaXMuZnJvbUpTKHByb3BzKTtcbiAgfVxuXG4gIC8qKiBXaGV0aGVyIGtleSBpcyBub24tZGVmYXVsdCAqL1xuICBzdGF0aWMgaGFzRGVmaW5lZDxUIGV4dGVuZHMgdHlwZW9mIFNpbXBsZVJlc291cmNlPihcbiAgICB0aGlzOiBULFxuICAgIGluc3RhbmNlOiBBYnN0cmFjdEluc3RhbmNlVHlwZTxUPixcbiAgICBrZXk6IEZpbHRlcjxrZXlvZiBBYnN0cmFjdEluc3RhbmNlVHlwZTxUPiwgc3RyaW5nPixcbiAgKSB7XG4gICAgcmV0dXJuICgoaW5zdGFuY2UgYXMgYW55KSBhcyBTaW1wbGVSZXNvdXJjZU1lbWJlcnM8VD4pW1xuICAgICAgRGVmaW5lZE1lbWJlcnNLZXlcbiAgICBdLmluY2x1ZGVzKGtleSk7XG4gIH1cblxuICAvKiogUmV0dXJucyBzaW1wbGUgb2JqZWN0IHdpdGggYWxsIHRoZSBub24tZGVmYXVsdCBtZW1iZXJzICovXG4gIHN0YXRpYyB0b09iamVjdERlZmluZWQ8VCBleHRlbmRzIHR5cGVvZiBTaW1wbGVSZXNvdXJjZT4oXG4gICAgdGhpczogVCxcbiAgICBpbnN0YW5jZTogQWJzdHJhY3RJbnN0YW5jZVR5cGU8VD4sXG4gICkge1xuICAgIGNvbnN0IGRlZmluZWQ6IFBhcnRpYWw8QWJzdHJhY3RJbnN0YW5jZVR5cGU8VD4+ID0ge307XG4gICAgZm9yIChjb25zdCBtZW1iZXIgb2YgKChpbnN0YW5jZSBhcyBhbnkpIGFzIFNpbXBsZVJlc291cmNlTWVtYmVyczxUPilbXG4gICAgICBEZWZpbmVkTWVtYmVyc0tleVxuICAgIF0pIHtcbiAgICAgIGRlZmluZWRbbWVtYmVyXSA9IGluc3RhbmNlW21lbWJlcl07XG4gICAgfVxuICAgIHJldHVybiBkZWZpbmVkO1xuICB9XG5cbiAgLyoqIFJldHVybnMgYXJyYXkgb2YgYWxsIGtleXMgdGhhdCBoYXZlIHZhbHVlcyBkZWZpbmVkIGluIGluc3RhbmNlICovXG4gIHN0YXRpYyBrZXlzRGVmaW5lZDxUIGV4dGVuZHMgdHlwZW9mIFNpbXBsZVJlc291cmNlPihcbiAgICB0aGlzOiBULFxuICAgIGluc3RhbmNlOiBBYnN0cmFjdEluc3RhbmNlVHlwZTxUPixcbiAgKSB7XG4gICAgcmV0dXJuICgoaW5zdGFuY2UgYXMgYW55KSBhcyBTaW1wbGVSZXNvdXJjZU1lbWJlcnM8VD4pW0RlZmluZWRNZW1iZXJzS2V5XTtcbiAgfVxuXG4gIHN0YXRpYyB0b1N0cmluZzxUIGV4dGVuZHMgdHlwZW9mIFNpbXBsZVJlc291cmNlPih0aGlzOiBUKSB7XG4gICAgcmV0dXJuIGAke3RoaXMubmFtZX06OiR7dGhpcy51cmxSb290fWA7XG4gIH1cblxuICAvKiogUmV0dXJucyB0aGUgZ2xvYmFsbHkgdW5pcXVlIGlkZW50aWZpZXIgZm9yIHRoaXMgU2ltcGxlUmVzb3VyY2UgKi9cbiAgc3RhdGljIGdldEtleTxUIGV4dGVuZHMgdHlwZW9mIFNpbXBsZVJlc291cmNlPih0aGlzOiBUKSB7XG4gICAgcmV0dXJuIHRoaXMudXJsUm9vdDtcbiAgfVxuXG4gIC8qKiBBIHVuaXF1ZSBpZGVudGlmaWVyIGZvciB0aGlzIFNpbXBsZVJlc291cmNlICovXG4gIHN0YXRpYyBwazxUIGV4dGVuZHMgdHlwZW9mIFNpbXBsZVJlc291cmNlPihcbiAgICB0aGlzOiBULFxuICAgIHBhcmFtczogUGFydGlhbDxBYnN0cmFjdEluc3RhbmNlVHlwZTxUPj4sXG4gICk6IHN0cmluZyB8IG51bWJlciB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMucHJvdG90eXBlLnBrLmNhbGwocGFyYW1zKTtcbiAgfVxuXG4gIC8qKiBVUkwgdG8gZmluZCB0aGlzIFNpbXBsZVJlc291cmNlICovXG4gIGdldCB1cmwoKTogc3RyaW5nIHtcbiAgICBpZiAodGhpcy5fX3VybCAhPT0gdW5kZWZpbmVkKSByZXR1cm4gdGhpcy5fX3VybDtcbiAgICAvLyB0eXBlc2NyaXB0IHRoaW5rcyBjb25zdHJ1Y3RvciBpcyBqdXN0IGEgZnVuY3Rpb25cbiAgICBjb25zdCBTdGF0aWMgPSB0aGlzLmNvbnN0cnVjdG9yIGFzIHR5cGVvZiBTaW1wbGVSZXNvdXJjZTtcbiAgICByZXR1cm4gU3RhdGljLnVybCh0aGlzKTtcbiAgfVxuICBwcml2YXRlIF9fdXJsPzogc3RyaW5nO1xuXG4gIC8qKiBHZXQgdGhlIHVybCBmb3IgYSBTaW1wbGVSZXNvdXJjZVxuICAgKlxuICAgKiBEZWZhdWx0IGltcGxlbWVudGF0aW9uIGNvbmZvcm1zIHRvIGNvbW1vbiBSRVNUIHBhdHRlcm5zXG4gICAqL1xuICBzdGF0aWMgdXJsPFQgZXh0ZW5kcyB0eXBlb2YgU2ltcGxlUmVzb3VyY2U+KFxuICAgIHRoaXM6IFQsXG4gICAgdXJsUGFyYW1zPzogUGFydGlhbDxBYnN0cmFjdEluc3RhbmNlVHlwZTxUPj4sXG4gICk6IHN0cmluZyB7XG4gICAgaWYgKHVybFBhcmFtcykge1xuICAgICAgaWYgKFxuICAgICAgICBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodXJsUGFyYW1zLCAndXJsJykgJiZcbiAgICAgICAgdXJsUGFyYW1zLnVybCAmJlxuICAgICAgICB0eXBlb2YgdXJsUGFyYW1zLnVybCA9PT0gJ3N0cmluZydcbiAgICAgICkge1xuICAgICAgICByZXR1cm4gdXJsUGFyYW1zLnVybDtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLnBrKHVybFBhcmFtcykgIT09IG51bGwpIHtcbiAgICAgICAgaWYgKHRoaXMudXJsUm9vdC5lbmRzV2l0aCgnLycpKSB7XG4gICAgICAgICAgcmV0dXJuIGAke3RoaXMudXJsUm9vdH0ke3RoaXMucGsodXJsUGFyYW1zKX1gO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBgJHt0aGlzLnVybFJvb3R9LyR7dGhpcy5wayh1cmxQYXJhbXMpfWA7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnVybFJvb3Q7XG4gIH1cblxuICAvKiogR2V0IHRoZSB1cmwgZm9yIG1hbnkgU2ltcGxlUmVzb3VyY2VzXG4gICAqXG4gICAqIERlZmF1bHQgaW1wbGVtZW50YXRpb24gY29uZm9ybXMgdG8gY29tbW9uIFJFU1QgcGF0dGVybnNcbiAgICovXG4gIHN0YXRpYyBsaXN0VXJsPFQgZXh0ZW5kcyB0eXBlb2YgU2ltcGxlUmVzb3VyY2U+KFxuICAgIHRoaXM6IFQsXG4gICAgc2VhcmNoUGFyYW1zPzogUmVhZG9ubHk8UmVjb3JkPHN0cmluZywgc3RyaW5nIHwgbnVtYmVyPj4sXG4gICk6IHN0cmluZyB7XG4gICAgaWYgKHNlYXJjaFBhcmFtcyAmJiBPYmplY3Qua2V5cyhzZWFyY2hQYXJhbXMpLmxlbmd0aCkge1xuICAgICAgY29uc3QgcGFyYW1zID0gbmV3IFVSTFNlYXJjaFBhcmFtcyhzZWFyY2hQYXJhbXMgYXMgYW55KTtcbiAgICAgIHBhcmFtcy5zb3J0KCk7XG4gICAgICByZXR1cm4gYCR7dGhpcy51cmxSb290fT8ke3BhcmFtcy50b1N0cmluZygpfWA7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnVybFJvb3Q7XG4gIH1cblxuICAvKiogUGVyZm9ybSBuZXR3b3JrIHJlcXVlc3QgYW5kIHJlc29sdmUgd2l0aCBqc29uIGJvZHkgKi9cbiAgc3RhdGljIGZldGNoPFQgZXh0ZW5kcyB0eXBlb2YgU2ltcGxlUmVzb3VyY2U+KFxuICAgIHRoaXM6IFQsXG4gICAgbWV0aG9kOiBNZXRob2QsXG4gICAgdXJsOiBzdHJpbmcsXG4gICAgYm9keT86IFJlYWRvbmx5PG9iamVjdCB8IHN0cmluZz4sXG4gICk6IFByb21pc2U8YW55PiB7XG4gICAgLy8gdHlwZXNjcmlwdCBjdXJyZW50bHkgZG9lc24ndCBhbGxvdyBhYnN0cmFjdCBzdGF0aWMgbWV0aG9kc1xuICAgIHRocm93IG5ldyBFcnJvcignbm90IGltcGxlbWVudGVkJyk7XG4gIH1cblxuICAvKiogR2V0IHRoZSBlbnRpdHkgc2NoZW1hIGRlZmluaW5nICAqL1xuICBzdGF0aWMgZ2V0RW50aXR5U2NoZW1hPFQgZXh0ZW5kcyB0eXBlb2YgU2ltcGxlUmVzb3VyY2U+KHRoaXM6IFQpIHtcbiAgICByZXR1cm4gZ2V0RW50aXR5U2NoZW1hKHRoaXMpO1xuICB9XG5cbiAgLyoqIEdldCB0aGUgcmVxdWVzdCBvcHRpb25zIGZvciB0aGlzIFNpbXBsZVJlc291cmNlICAqL1xuICBzdGF0aWMgZ2V0RmV0Y2hPcHRpb25zPFQgZXh0ZW5kcyB0eXBlb2YgU2ltcGxlUmVzb3VyY2U+KFxuICAgIHRoaXM6IFQsXG4gICk6IEZldGNoT3B0aW9ucyB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgLy8gVE9ETzogbWVtb2l6ZSB0aGVzZSBzbyB0aGV5IGNhbiBiZSByZWZlcmVudGlhbGx5IGNvbXBhcmVkXG4gIC8qKiBTaGFwZSB0byBnZXQgYSBzaW5nbGUgZW50aXR5ICovXG4gIHN0YXRpYyBkZXRhaWxTaGFwZTxUIGV4dGVuZHMgdHlwZW9mIFNpbXBsZVJlc291cmNlPihcbiAgICB0aGlzOiBULFxuICApOiBSZWFkU2hhcGU8U2NoZW1hRGV0YWlsPFJlYWRvbmx5PEFic3RyYWN0SW5zdGFuY2VUeXBlPFQ+Pj4+IHtcbiAgICBjb25zdCBnZXRGZXRjaEtleSA9IChwYXJhbXM6IFJlYWRvbmx5PG9iamVjdD4pID0+IHtcbiAgICAgIHJldHVybiAnR0VUICcgKyB0aGlzLnVybChwYXJhbXMpO1xuICAgIH07XG4gICAgY29uc3Qgc2NoZW1hID0gdGhpcy5nZXRFbnRpdHlTY2hlbWEoKTtcbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5nZXRGZXRjaE9wdGlvbnMoKTtcbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogJ3JlYWQnLFxuICAgICAgc2NoZW1hLFxuICAgICAgb3B0aW9ucyxcbiAgICAgIGdldEZldGNoS2V5LFxuICAgICAgZmV0Y2g6IChwYXJhbXM6IFJlYWRvbmx5PG9iamVjdD4pID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmV0Y2goJ2dldCcsIHRoaXMudXJsKHBhcmFtcykpO1xuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgLyoqIFNoYXBlIHRvIGdldCBhIGxpc3Qgb2YgZW50aXRpZXMgKi9cbiAgc3RhdGljIGxpc3RTaGFwZTxUIGV4dGVuZHMgdHlwZW9mIFNpbXBsZVJlc291cmNlPihcbiAgICB0aGlzOiBULFxuICApOiBSZWFkU2hhcGU8U2NoZW1hTGlzdDxSZWFkb25seTxBYnN0cmFjdEluc3RhbmNlVHlwZTxUPj4+PiB7XG4gICAgY29uc3QgZ2V0RmV0Y2hLZXkgPSAocGFyYW1zOiBSZWFkb25seTxSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+PikgPT4ge1xuICAgICAgcmV0dXJuICdHRVQgJyArIHRoaXMubGlzdFVybChwYXJhbXMpO1xuICAgIH07XG4gICAgY29uc3Qgc2NoZW1hID0gW3RoaXMuZ2V0RW50aXR5U2NoZW1hKCldO1xuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLmdldEZldGNoT3B0aW9ucygpO1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiAncmVhZCcsXG4gICAgICBzY2hlbWEsXG4gICAgICBvcHRpb25zLFxuICAgICAgZ2V0RmV0Y2hLZXksXG4gICAgICBmZXRjaDogKHBhcmFtczogUmVhZG9ubHk8UmVjb3JkPHN0cmluZywgc3RyaW5nIHwgbnVtYmVyPj4pID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmV0Y2goJ2dldCcsIHRoaXMubGlzdFVybChwYXJhbXMpKTtcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIC8qKiBTaGFwZSB0byBjcmVhdGUgYSBuZXcgZW50aXR5IChwb3N0KSAqL1xuICBzdGF0aWMgY3JlYXRlU2hhcGU8VCBleHRlbmRzIHR5cGVvZiBTaW1wbGVSZXNvdXJjZT4oXG4gICAgdGhpczogVCxcbiAgKTogTXV0YXRlU2hhcGU8XG4gICAgU2NoZW1hRGV0YWlsPFJlYWRvbmx5PEFic3RyYWN0SW5zdGFuY2VUeXBlPFQ+Pj4sXG4gICAgUmVhZG9ubHk8b2JqZWN0PixcbiAgICBQYXJ0aWFsPEFic3RyYWN0SW5zdGFuY2VUeXBlPFQ+PlxuICA+IHtcbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5nZXRGZXRjaE9wdGlvbnMoKTtcbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogJ211dGF0ZScsXG4gICAgICBzY2hlbWE6IHRoaXMuZ2V0RW50aXR5U2NoZW1hKCksXG4gICAgICBvcHRpb25zLFxuICAgICAgZ2V0RmV0Y2hLZXk6IChwYXJhbXM6IFJlYWRvbmx5PFJlY29yZDxzdHJpbmcsIHN0cmluZz4+KSA9PiB7XG4gICAgICAgIHJldHVybiAnUE9TVCAnICsgdGhpcy5saXN0VXJsKHBhcmFtcyk7XG4gICAgICB9LFxuICAgICAgZmV0Y2g6IChcbiAgICAgICAgcGFyYW1zOiBSZWFkb25seTxSZWNvcmQ8c3RyaW5nLCBzdHJpbmcgfCBudW1iZXI+PixcbiAgICAgICAgYm9keTogUGFydGlhbDxBYnN0cmFjdEluc3RhbmNlVHlwZTxUPj4sXG4gICAgICApID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmV0Y2goJ3Bvc3QnLCB0aGlzLmxpc3RVcmwocGFyYW1zKSwgYm9keSk7XG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICAvKiogU2hhcGUgdG8gdXBkYXRlIGFuIGV4aXN0aW5nIGVudGl0eSAocHV0KSAqL1xuICBzdGF0aWMgdXBkYXRlU2hhcGU8VCBleHRlbmRzIHR5cGVvZiBTaW1wbGVSZXNvdXJjZT4oXG4gICAgdGhpczogVCxcbiAgKTogTXV0YXRlU2hhcGU8XG4gICAgU2NoZW1hRGV0YWlsPFJlYWRvbmx5PEFic3RyYWN0SW5zdGFuY2VUeXBlPFQ+Pj4sXG4gICAgUmVhZG9ubHk8b2JqZWN0PixcbiAgICBQYXJ0aWFsPEFic3RyYWN0SW5zdGFuY2VUeXBlPFQ+PlxuICA+IHtcbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5nZXRGZXRjaE9wdGlvbnMoKTtcbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogJ211dGF0ZScsXG4gICAgICBzY2hlbWE6IHRoaXMuZ2V0RW50aXR5U2NoZW1hKCksXG4gICAgICBvcHRpb25zLFxuICAgICAgZ2V0RmV0Y2hLZXk6IChwYXJhbXM6IG9iamVjdCkgPT4ge1xuICAgICAgICByZXR1cm4gJ1BVVCAnICsgdGhpcy51cmwocGFyYW1zKTtcbiAgICAgIH0sXG4gICAgICBmZXRjaDogKFxuICAgICAgICBwYXJhbXM6IFJlYWRvbmx5PG9iamVjdD4sXG4gICAgICAgIGJvZHk6IFBhcnRpYWw8QWJzdHJhY3RJbnN0YW5jZVR5cGU8VD4+LFxuICAgICAgKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmZldGNoKCdwdXQnLCB0aGlzLnVybChwYXJhbXMpLCBib2R5KTtcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIC8qKiBTaGFwZSB0byB1cGRhdGUgYSBzdWJzZXQgb2YgZmllbGRzIG9mIGFuIGV4aXN0aW5nIGVudGl0eSAocGF0Y2gpICovXG4gIHN0YXRpYyBwYXJ0aWFsVXBkYXRlU2hhcGU8VCBleHRlbmRzIHR5cGVvZiBTaW1wbGVSZXNvdXJjZT4oXG4gICAgdGhpczogVCxcbiAgKTogTXV0YXRlU2hhcGU8XG4gICAgU2NoZW1hRGV0YWlsPFJlYWRvbmx5PEFic3RyYWN0SW5zdGFuY2VUeXBlPFQ+Pj4sXG4gICAgUmVhZG9ubHk8b2JqZWN0PixcbiAgICBQYXJ0aWFsPEFic3RyYWN0SW5zdGFuY2VUeXBlPFQ+PlxuICA+IHtcbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5nZXRGZXRjaE9wdGlvbnMoKTtcbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogJ211dGF0ZScsXG4gICAgICBzY2hlbWE6IHRoaXMuZ2V0RW50aXR5U2NoZW1hKCksIC8vVE9ETzogY2hhbmdlIG1lcmdlIHN0cmF0ZWd5IGluIGNhc2Ugd2Ugd2FudCB0byBoYW5kbGUgcGFydGlhbCByZXR1cm5zXG4gICAgICBvcHRpb25zLFxuICAgICAgZ2V0RmV0Y2hLZXk6IChwYXJhbXM6IFJlYWRvbmx5PG9iamVjdD4pID0+IHtcbiAgICAgICAgcmV0dXJuICdQQVRDSCAnICsgdGhpcy51cmwocGFyYW1zKTtcbiAgICAgIH0sXG4gICAgICBmZXRjaDogKFxuICAgICAgICBwYXJhbXM6IFJlYWRvbmx5PG9iamVjdD4sXG4gICAgICAgIGJvZHk6IFBhcnRpYWw8QWJzdHJhY3RJbnN0YW5jZVR5cGU8VD4+LFxuICAgICAgKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmZldGNoKCdwYXRjaCcsIHRoaXMudXJsKHBhcmFtcyksIGJvZHkpO1xuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgLyoqIFNoYXBlIHRvIGRlbGV0ZSBhbiBlbnRpdHkgKGRlbGV0ZSkgKi9cbiAgc3RhdGljIGRlbGV0ZVNoYXBlPFQgZXh0ZW5kcyB0eXBlb2YgU2ltcGxlUmVzb3VyY2U+KFxuICAgIHRoaXM6IFQsXG4gICk6IERlbGV0ZVNoYXBlPGFueSwgUmVhZG9ubHk8b2JqZWN0Pj4ge1xuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLmdldEZldGNoT3B0aW9ucygpO1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiAnZGVsZXRlJyxcbiAgICAgIHNjaGVtYTogdGhpcy5nZXRFbnRpdHlTY2hlbWEoKSxcbiAgICAgIG9wdGlvbnMsXG4gICAgICBnZXRGZXRjaEtleTogKHBhcmFtczogb2JqZWN0KSA9PiB7XG4gICAgICAgIHJldHVybiAnREVMRVRFICcgKyB0aGlzLnVybChwYXJhbXMpO1xuICAgICAgfSxcbiAgICAgIGZldGNoOiAocGFyYW1zOiBSZWFkb25seTxvYmplY3Q+KSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmZldGNoKCdkZWxldGUnLCB0aGlzLnVybChwYXJhbXMpKTtcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxufVxuXG4vLyBXZSdyZSBvbmx5IGFsbG93aW5nIHRoaXMgdG8gZ2V0IHNldCBmb3IgZGVzY2VuZGFudHMgYnV0XG4vLyBieSBkZWZhdWx0IHdlIHdhbnQgVHlwZXNjcmlwdCB0byB0cmVhdCBpdCBhcyByZWFkb25seS5cbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShTaW1wbGVSZXNvdXJjZS5wcm90b3R5cGUsICd1cmwnLCB7XG4gIHNldCh1cmw6IHN0cmluZykge1xuICAgIHRoaXMuX191cmwgPSB1cmw7XG4gIH0sXG59KTtcblxudHlwZSBHZXRFbnRpdHlTY2hlbWEgPSA8VCBleHRlbmRzIHR5cGVvZiBTaW1wbGVSZXNvdXJjZT4oXG4gIFJlc291cmNlQ2xhc3M6IFQsXG4pID0+IHNjaGVtYXMuRW50aXR5PFJlYWRvbmx5PEFic3RyYWN0SW5zdGFuY2VUeXBlPFQ+Pj47XG5cbmNvbnN0IGdldEVudGl0eVNjaGVtYTogR2V0RW50aXR5U2NoZW1hID0gbWVtb2l6ZShcbiAgPFQgZXh0ZW5kcyB0eXBlb2YgU2ltcGxlUmVzb3VyY2U+KFJlc291cmNlQ2xhc3M6IFQpID0+IHtcbiAgICBjb25zdCBlID0gbmV3IHNjaGVtYXMuRW50aXR5KFxuICAgICAgUmVzb3VyY2VDbGFzcy5nZXRLZXkoKSxcbiAgICAgIHt9LFxuICAgICAge1xuICAgICAgICBpZEF0dHJpYnV0ZTogKHZhbHVlLCBwYXJlbnQsIGtleSkgPT4ge1xuICAgICAgICAgIGNvbnN0IGlkID0gUmVzb3VyY2VDbGFzcy5wayh2YWx1ZSkgfHwga2V5O1xuICAgICAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGlkID09PSBudWxsKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICAgIGBNaXNzaW5nIHVzYWJsZSByZXNvdXJjZSBrZXkgd2hlbiBub3JtYWxpemluZyByZXNwb25zZS5cblxuVGhpcyBpcyBsaWtlbHkgZHVlIHRvIGEgbWFsZm9ybWVkIHJlc3BvbnNlLlxuVHJ5IGluc3BlY3RpbmcgdGhlIG5ldHdvcmsgcmVzcG9uc2Ugb3IgZmV0Y2goKSByZXR1cm4gdmFsdWUuXG5gLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGlkLnRvU3RyaW5nKCk7XG4gICAgICAgIH0sXG4gICAgICAgIHByb2Nlc3NTdHJhdGVneTogdmFsdWUgPT4ge1xuICAgICAgICAgIHJldHVybiBSZXNvdXJjZUNsYXNzLmZyb21KUyh2YWx1ZSk7XG4gICAgICAgIH0sXG4gICAgICAgIG1lcmdlU3RyYXRlZ3k6IChcbiAgICAgICAgICBhOiBBYnN0cmFjdEluc3RhbmNlVHlwZTxUPixcbiAgICAgICAgICBiOiBBYnN0cmFjdEluc3RhbmNlVHlwZTxUPixcbiAgICAgICAgKSA9PiAoYS5jb25zdHJ1Y3RvciBhcyBUKS5tZXJnZShhLCBiKSxcbiAgICAgIH0sXG4gICAgKTtcbiAgICAvLyBUT0RPOiBsb25nIHRlcm0gZmlndXJlIG91dCBhIHBsYW4gdG8gYWN0dWFsbHkgZGVub3JtYWxpemVcbiAgICAoZSBhcyBhbnkpLmRlbm9ybWFsaXplID0gZnVuY3Rpb24gZGVub3JtYWxpemUoZW50aXR5OiBhbnkpIHtcbiAgICAgIHJldHVybiBbZW50aXR5LCB0cnVlXTtcbiAgICB9O1xuICAgIHJldHVybiBlO1xuICB9LFxuKSBhcyBhbnk7XG4iXX0=